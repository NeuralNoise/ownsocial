<div class="conversation_index">
	<div class="row">

		<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
			<div class="">
				<?php if ($this->conversations): ?>
					<ul class="nav nav-pills nav-stacked">
					<?php foreach ($this->conversations as $i => $conversation): ?>
						<li role="presentation" class="conversation <?= ($i === 0) ? ' active' : ''; ?>" data-conversation-id="<?= $conversation->getId(); ?>">
							<a href="#">
								<strong><?= $this->escape($conversation->getTitle()); ?></strong><br />
								<small>
									<?php if ($lastPost = $conversation->getLastPost($this->_currentUser->getId())): ?>
										<?= $this->escape($this->shorten($lastPost->getMessage(), 50)); ?>
									<?php else: ?>
										<p><?= $this->_('conversations_no_posts_yet'); ?></p>
									<?php endif; ?>
								</small>
							</a>
						</li>
					<?php endforeach; ?>
					</ul>
				<?php else: ?>
					<p><?= $this->_('conversations_no_conversations_yet'); ?></p>
				<?php endif; ?>
			</div>
		</div>

		<div class="col-xm-8 col-sm-8 col-md-8 col-lg-8">

			<div class="well well-sm">
				<span><?= $this->_('conversations_members'); ?>: <span id="conversation_member"></span></span>
			</div>

			<div class="well well-sm">

				<div id="message_box" style="height: 350px; padding: 20px; overflow-y: auto;">

					<div class="alert alert-warning load_more_posts" style="text-align: center; displ ay: none;">
						<a href="#"><?= $this->_('conversations_load_more_posts'); ?></a>
					</div>

					<div id="message_box_inner">
						<hr>
					</div>

				</div>

			</div>

			<div class="well well-sm">

				<div id="add_message_box" style="height: 80px;">

					<textarea class="form-control" id="conversation_post_message"></textarea>

					<button class="btn btn-primary" id="conversation_post_add"><?= $this->_('conversation_create_post'); ?></button>

				</div>

			</div>
		</div>
	</div>
</div>

<script type="text/javascript">

$(function() {

	var currentConversation = <?= json_encode($this->conversations[0]->getId()); ?>;

	var loadPosts = function(offset, callback) {

		if (typeof offset == 'undefined') {
			offset = 0;
		}

		$.ajax({
			method: 'post',
			url: '/conversation/get-posts/',
			data: {
				conversation_id: currentConversation,
				offset: offset
			},
			dataType: 'json',
			success: function(result) {

				for (var i = 0; i < result.length; i++) {

					var post = result[i];

					if ($('#message_' + post.id).length === 0) {

						var message = $('<div class="row message" id="message_' + post.id + '"></div>');

						$(message).append('<div class="col-xs-2"><a href="/profile/?user=' + post.user.id + '"><img class="img-responsive" src="/file/?file=' + post.user.portrait_file_id + '" /></a></div>');

						var rightCol = $('<div class="col-xs-10"><a href="/profile/?user=' + post.user.id + '">' + post.user.first_name + ' ' + post.user.last_name + '</a></div>');

						$(rightCol).appendTo(message);

						$(rightCol).append('<p>' + result[i].message + '</p>');
						$(message).prependTo('#message_box_inner');
						$('<hr>').prependTo('#message_box_inner');

					}
				}

				if (typeof callback !== 'undefined') {
					callback(result.length);
				}
			}
		});
	};

	var loadMembers = function(conversationId) {

		$.ajax({
			method: 'post',
			url: '/conversation/get-members/',
			data: {
				conversation_id: conversationId
			},
			dataType: 'json',
			success: function (result) {

				var memberSpan = $('#conversation_member');

				$(memberSpan).html('');

				for (var i = 0; i < result.length; i++) {

					var user = result[i];

					memberSpan.append('<a href="/profile/?user=' + user.id + '">' + user.first_name + ' ' + user.last_name + '</a>');

					if (i < (result.length - 1)) {
						memberSpan.append(', ');
					}
				}

			}
		});

	};

	loadMembers(currentConversation);

	loadPosts(0, function() {
		$('#message_box').animate({scrollTop: 9999999}, 1);
	});

	$('.load_more_posts a').click(function(event) {

		event.preventDefault();

		var heightBefore = $(this).height();

		loadPosts($('.message').length, function(loadedPosts) {

			if (loadedPosts > 0) {
				$('#message_box').animate({scrollTop: $(this).height() - heightBefore }, 1);
			}

		});

	});

	$('.conversation').click(function(event) {

		event.preventDefault();

		currentConversation = $(this).data('conversation-id');

		$('.conversation').removeClass('active');
		$(this).addClass('active');

		$('#message_box_inner').html('');

		loadMembers(currentConversation);

		loadPosts(0, function() {
			$('#message_box').animate({scrollTop: 9999999}, 1);
		});

	});

	$('#conversation_post_add').click(function(event) {

		event.preventDefault();

		$.ajax({
			method: 'post',
			url: '/conversation/add-post/',
			data: {
				conversation_id: currentConversation,
				message: $('#conversation_post_message').val()
			},
			dataType: 'json',
			success: function (result) {

				if (result.success) {

					$('#conversation_post_message').val('');
					$('#message_box_inner').html('');

					loadPosts(function() {
						$('#message_box').animate({scrollTop: 9999999}, 1);
					});

				}
			}
		});
	});

});

</script>